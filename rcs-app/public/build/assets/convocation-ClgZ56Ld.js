const f={upload:"/api/upload",list:"/api/documents",delAll:"/api/documents",search:"/api/search"};function s(n){return document.querySelector(n)}function g(n,t={}){const e=document.createElement(n);return Object.assign(e,t),e}document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("year");n&&(n.textContent=new Date().getFullYear()),p();const t=s("#uploadForm");t&&t.addEventListener("submit",async m=>{m.preventDefault();const c=s("#file").files[0];if(!c)return;const i=new FormData;i.append("file",c),s("#session")?.value&&i.append("session",s("#session").value);const l=s("#start_page")?.value?.trim();l&&i.append("start_page",l);const u=s("#end_page")?.value?.trim();u&&i.append("end_page",u);const r=s("#uploadMsg");r&&(r.textContent="Uploading...");try{await(await fetch(f.upload,{method:"POST",body:i})).json(),r&&(r.textContent="Queued for processing. Refresh documents shortly."),p()}catch{r&&(r.textContent="Upload failed.")}});const e=s("#deleteAllBtn");e&&e.addEventListener("click",async()=>{confirm("Delete ALL PDFs and extracted data?")&&(await fetch(f.delAll,{method:"DELETE"}),p())});const a=s("#searchForm");a&&a.addEventListener("submit",async m=>{m.preventDefault();const c=new URLSearchParams,i=s("#q")?.value?.trim();i&&c.set("q",i);const l=s("#faculty")?.value?.trim();l&&c.set("faculty",l);const u=s("#grade")?.value?.trim();u&&c.set("grade",u);const r=s("#sess")?.value?.trim();r&&c.set("session",r);const d=s("#searchMsg");d&&(d.textContent="Searching...");try{const h=await(await fetch(f.search+"?"+c.toString())).json();w(h.data||[]),d&&(d.textContent=`${(h.data||[]).length} results`)}catch{d&&(d.textContent="Search failed.")}})});async function p(){try{const t=await(await fetch(f.list)).json();v(t)}catch{}}function v(n){const t=document.querySelector("#docsTable tbody");t&&(t.innerHTML="",n.forEach(e=>{const a=g("tr");a.append(o(e.id),o(e.filename),o(e.session||""),o(e.status),y(e.csv_download),y(e.xlsx_download),o(new Date(e.created_at).toLocaleString())),t.appendChild(a)}))}function w(n){const t=document.querySelector("#resultsTable tbody");t&&(t.innerHTML="",n.forEach(e=>{const a=g("tr");a.append(o(e.surname),o(e.first_name),o(e.other_name||""),o(e.course_studied||""),o(e.faculty||""),o(e.grade||""),o(e.qualification_obtained||""),o(e.session||"")),t.appendChild(a)}))}function o(n){const t=document.createElement("td");return t.textContent=n??"",t.className="p-2 border-b",t}function y(n,t){const e=document.createElement("td");if(e.className="p-2 border-b",n){const a=document.createElement("a");a.href=n,a.className="text-lime-700 underline",a.textContent="Download",a.setAttribute("download",""),e.appendChild(a)}return e}
