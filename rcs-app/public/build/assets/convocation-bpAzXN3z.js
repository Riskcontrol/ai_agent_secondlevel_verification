const u={upload:"/api/upload",list:"/api/documents",delAll:"/api/documents",search:"/api/search"};function s(n){return document.querySelector(n)}function g(n,t={}){const e=document.createElement(n);return Object.assign(e,t),e}document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("year");n&&(n.textContent=new Date().getFullYear()),m();const t=s("#uploadForm");t&&t.addEventListener("submit",async f=>{f.preventDefault();const r=s("#file").files[0];if(!r)return;const i=new FormData;i.append("file",r),s("#session")?.value&&i.append("session",s("#session").value);const o=s("#uploadMsg");o&&(o.textContent="Uploading...");try{await(await fetch(u.upload,{method:"POST",body:i})).json(),o&&(o.textContent="Queued for processing. Refresh documents shortly."),m()}catch{o&&(o.textContent="Upload failed.")}});const e=s("#deleteAllBtn");e&&e.addEventListener("click",async()=>{confirm("Delete ALL PDFs and extracted data?")&&(await fetch(u.delAll,{method:"DELETE"}),m())});const c=s("#searchForm");c&&c.addEventListener("submit",async f=>{f.preventDefault();const r=new URLSearchParams,i=s("#q")?.value?.trim();i&&r.set("q",i);const o=s("#faculty")?.value?.trim();o&&r.set("faculty",o);const l=s("#grade")?.value?.trim();l&&r.set("grade",l);const h=s("#sess")?.value?.trim();h&&r.set("session",h);const d=s("#searchMsg");d&&(d.textContent="Searching...");try{const y=await(await fetch(u.search+"?"+r.toString())).json();E(y.data||[]),d&&(d.textContent=`${(y.data||[]).length} results`)}catch{d&&(d.textContent="Search failed.")}})});async function m(){try{const t=await(await fetch(u.list)).json();x(t)}catch{}}function x(n){const t=document.querySelector("#docsTable tbody");t&&(t.innerHTML="",n.forEach(e=>{const c=g("tr");c.append(a(e.id),a(e.filename),a(e.session||""),a(e.status),p(e.csv_url),p(e.xlsx_url),p(e.docx_url),a(new Date(e.created_at).toLocaleString())),t.appendChild(c)}))}function E(n){const t=document.querySelector("#resultsTable tbody");t&&(t.innerHTML="",n.forEach(e=>{const c=g("tr");c.append(a(e.surname),a(e.first_name),a(e.other_name||""),a(e.course_studied||""),a(e.faculty||""),a(e.grade||""),a(e.qualification_obtained||""),a(e.session||"")),t.appendChild(c)}))}function a(n){const t=document.createElement("td");return t.textContent=n??"",t.className="p-2 border-b",t}function p(n){const t=document.createElement("td");if(t.className="p-2 border-b",n){const e=document.createElement("a");e.href=n,e.target="_blank",e.className="text-lime-700 underline",e.textContent="Download",t.appendChild(e)}return t}
